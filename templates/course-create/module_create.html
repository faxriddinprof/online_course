{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Progress bar -->
<div class="progress-container">
    <div class="step done">
        <div class="step-title">1. Kurs</div>
        <div class="step-circle">1</div>
        <div class="step-line"></div>
    </div>
    <div class="step done">
        <div class="step-title">2. Boâ€˜lim</div>
        <div class="step-circle">2</div>
        <div class="step-line"></div>
    </div>
    <div class="step active">
        <div class="step-title">3. Modul</div>
        <div class="step-circle">3</div>
    </div>
</div>

<div class="form-container">
    <h2>ðŸ“š Modul qoâ€˜shish</h2>
    <form id="moduleForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="section_id" class="form-label">Boâ€˜lim tanlang:</label>
            <select name="section_id" id="section_id" class="form-select" required>
                {% for sec in course.sections.all %}
                    <option value="{{ sec.id }}" {% if sec.id == section.id %}selected{% endif %}>
                        {{ sec.title }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-fields">
            {{ form.as_p }}
        </div>

        <button type="submit" class="btn btn-primary w-100">âž• Modul qoâ€˜shish</button>
    </form>

    <hr>

    <h3>ðŸ“‚ Mavjud modullar:</h3>
    <ul id="moduleList" class="list-group">
        {% for module in section.modules.all %}
            <li class="list-group-item">{{ module.title }}</li>
        {% empty %}
            <li class="list-group-item">Hozircha modul yoâ€˜q</li>
        {% endfor %}
    </ul>
</div>

<script>
document.getElementById("moduleForm")?.addEventListener("submit", function(e){
    e.preventDefault();
    let formData = new FormData(this);

    fetch("{% url 'module-create' section.id %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            let list = document.getElementById("moduleList");
            list.innerHTML = "";
            data.modules.forEach(m => {
                let li = document.createElement("li");
                li.className = "list-group-item";
                li.textContent = m.title;
                list.appendChild(li);
            });
            this.reset();
            // Success message
            let alert = document.createElement("div");
            alert.className = "alert alert-success mt-3";
            alert.textContent = "âœ… Modul muvaffaqiyatli qoâ€˜shildi!";
            document.querySelector(".form-container").prepend(alert);
            setTimeout(() => alert.remove(), 3000);
        } else if (data.errors) {
            alert("Xatolik: " + JSON.stringify(data.errors));
        }
    })
    .catch(err => console.error("Xatolik:", err));
});
</script>
{% endblock %}
